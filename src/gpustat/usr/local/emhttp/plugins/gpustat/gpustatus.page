Menu="Dashboard:0"
Icon="gpustat.png"
---
<?php
 
/*
  Create a .page file based on this example file and store the file in your plugin directory
  Make sure this file has a unique name not used by the GUI or other plugins

  This is an example configuration which is used to add custom tiles to the dashboard
  Placement of one or more custom tiles is done under column1, column2 or column3
  A column can have as many new custom tiles as needed, each custom tile is a <tbody> element
  Each tile must have these two properties set:

  "_(description)_"    - this is the (translated) description shown in the Content Manager window
  "_(Tile tile)_"      - this is the (translated) title of the tile shown in bold on the screen

  The content of the tile can be any text as required by your plugin, this content is placed inside the <td> element
  A number of predefined spans are available to make fields of certain widths and maybe used to follow the GUI alignment
  These are:
  <span class="w18">
  <span class="w26">
  <span class="w36">
  <span class="w44">
  <span class="w72">
*/

$pluginname = "gpustat"; // substitute this entry with the name of your plugin

$gpustat_cfg = parse_plugin_cfg('gpustat', true);
if (!isset($gpustat_cfg["MULTIGPUJSON"])) $gpustat_cfg["MULTIGPUJSON"] = "%7B%22%22%3A%7B%22id%22%3A%22None%22%2C%22model%22%3A%22None%22%2C%22vendor%22%3A%22None%22%2C%22guid%22%3A%22None%22%7D%7D" ;
$multi = urldecode($gpustat_cfg["MULTIGPUJSON"]) ;
$multigpus = json_decode($multi,true) ;
$gpu_nv = $gpu_intel = $gpu_amd = $gpu_unknown = false;

$apps = [
    'plex', 'jellyfin', 'handbrake', 'emby', 'tdarr', 'unmanic', 'dizquetv', 'ersatztv',
    'fileflows', 'frigate', 'deepstack', 'nsfminer', 'shinobipro', 'foldinghome',
];

$i= $j =$k = 1;  
$gpus_selected = count($multigpus) ;

foreach ($multigpus as $id=>$gpu) {
    $gpu_nv = $gpu_intel = $gpu_amd = $gpu_unknown = false;
    switch ($gpu['vendor']) {
        case "nvidia":
            $gpu_nv = true;
            break;
        case "intel":
            $gpu_intel = true;
            break;
        case "amd":
            $gpu_amd = true;
            break;
        default:
            // If vendor isn't set the config hasn't been saved, don't render the plugin
            $gpu_unknown = true;
            $unknown_msg = "No GPUs selected - Select GPU(s) in GPUStat settings page and apply.";
    }

    if ($gpus_selected > 1) $gpu_tag = $i ; else $gpu_tag = "" ;
        $stats = "<div class='section'>_(GPU".$gpu_tag." - )_";
        $stats .= "<span class='gpu{$i}-vendor'></span>&nbsp;<span class='gpu{$i}-name'></span>&nbsp;<span>(<span class='gpu{$i}-passedthrough'></span>)</span><br>";
        $stats .= "<i class='fa fa-microchip fa-1x'></i>&nbsp<span class='gpu-stats-primary gpu{$i}-util'></span>&nbsp;&nbsp;&nbsp;";
        if ($gpu_nv || $gpu_amd) {
        if ($gpustat_cfg['DISPTEMP']) $stats .= "<i class='fa fa-thermometer-half fa-1x'></i>&nbsp;<span class='gpu-stats-primary gpu{$i}-temp'></span>&nbsp;&nbsp;&nbsp;" ;
        $stats .= "<span title='PCIe Gen' class='gpu-stats-primary'><i class='fa fa-cogs fa-1x'></i>&nbsp;<span class='gpu{$i}-pciegen'></span>&nbsp;<i id='gpu{$i}-pciegen-arrow' class='fa fa-caret-down fa-1x' style='color:red; display: inline;'></i><span>&nbsp;-&nbsp;</span><span class='gpu{$i}-pciewidth'></span>&nbsp;<i id='gpu{$i}-pciewidth-arrow' class='fa fa-caret-down fa-1x' style='color:red; display: inline;'></i></span>&nbsp;&nbsp;&nbsp;" ;
        }
        if ($gpu_nv && $gpustat_cfg['DISPSESSIONS']) $stats .="<span> Processes: <span class='gpu{$i}-sessions'></span></span>";
    $stats .= "<br><br></div>" ;
    $layout = GPULayout($i, $gpu["vendor"],$gpustat_cfg) ;
    $mytiles[$pluginname.$k]['column'.$j] =
    <<<EOT
    <tbody id="tblGPUDash$i" title="_(GPU #$i Stats)_">
    <tr><td><i class='icon-hardware f32'></i>
    $stats
    <a href="Dashboard/Settings/GPUStatSettings" title="_(Go to GPU Statistics settings)_"><i class="fa fa-fw fa-cog control"></i></a></td></tr>
    $layout
    </tbody>
    EOT;
    $multigpus[$id]["panel"] = $i ;
    $i++ ; #GPU Number
    $j++ ; #Default Column
    if ($j >3) { $j=1 ; $k++ ;} #Plugin name in array. Only 3 Dashboards per name.
}


function GPULayout($count,$vendor,$gpustat_cfg) {

$gpu_nv = $gpu_intel = $gpu_amd = $gpu_unknown = false;
    switch ($vendor) {
    case "nvidia":
        $gpu_nv = true;
        break;
    case "intel":
        $gpu_intel = true;
        break;
    case "amd":
        $gpu_amd = true;
        break;
    default:
        // If vendor isn't set the config hasn't been saved, don't render the plugin
        $gpu_unknown = true;
        $unknown_msg = "No GPUs selected - Select GPU(s) in GPUStat settings page and apply.";
}

    //$page_render = '<tr class="updated"><td>' ;

    # No GPU Set 

    if ($gpu_unknown)  $page_render .= "<tr><td><span>_(No GPUs selected - Select GPU(s) in GPUStat settings page and apply.)_</span></td></tr>" ; 

  
    

    return($page_render) ;    
}


?>
<style type="text/css">
    @import url("/plugins/gpustat/css/style.css");
</style>




<script id="message-template-bars" type="text/template">
    <tr><td><span class='w36'><i class='ups fa fa-fw icon-hardware'></i>_({{label1}})_<span class='hidden'>_( / {{label2}})_</span></span>
    <span class='w26'><span class='gpu{{gpuNR}}-{{stat1}} load'>0%</span><div class='usage-disk sys'><span class='gpu{{gpuNR}}-{{stat1}}bar' id='gpu{{gpuNR}}-{{stat1}}bar'></span><span></span></div></span>
    <span class='w26'><span class='hidden'><span class='gpu{{gpuNR}}-{{stat2}} load'>0%</span><div class='usage-disk sys'><span class='gpu{{gpuNR}}-{{stat2}}bar' id='gpu{{gpuNR}}-{{stat2}}bar'></span><span></span></div></span></span>
    </td></tr>
</script>

<script id="message-template-simple" type="text/template">
<tr><td colspan ='3' id="gpu-labels" >
    <span class='w36'><i class='ups fa fa-fw icon-hardware'></i>_({{label1}})_: <span class='gpu{{gpuNR}}-{{stat1}}'></span></span>
    <span class='w26'><span class='hidden'><i class='ups fa fa-fw icon-hardware'></i>_({{label2}})_: <span class='gpu{{gpuNR}}-{{stat2}}'></span></span></span>
    <span class='w18'><span class='hidden'><i class='ups fa fa-fw icon-hardware'></i>_({{label3}})_: <span class='gpu{{gpuNR}}-{{stat3}}'></span></span></span>
    </td></tr>
</script>

<script id="message-template-sessions" type="text/template">
    <tr>
        <td colspan ='2' >
            <span class='w36'><i class='ups fa fa-fw icon-hardware'></i>_(Active Apps)_</span>
            <?php foreach($apps as $app): ?>
                <span id='w16 gpu{{gpuNR}}-img-span-<?=$app?>' class='hidden gpu{{gpuNR}}-img-span-<?=$app?>'>
                    <img id='gpu{{gpuNR}}-<?=$app?>' class='gpu-image' src='/plugins/gpustat/images/<?=$app?>.png'>
                </span>
            <?php endforeach; ?>
        </td>
    </tr>
</script>

<script type="text/javascript" src="/plugins/gpustat/scripts/gpustat.js"></script>
<script type="text/javascript">
    $(document).ready(function() {
        function refresh() {
            $(gpustat_status(<?=json_encode($multigpus);?>));
        }

        $(gpustat_dash_build(<?=json_encode($multigpus);?>)).promise().done(function() {
            $(gpustat_status(<?=json_encode($multigpus);?>));

            if (<?=$gpustat_cfg['UIREFRESH'];?>) {
                setInterval(refresh, <?=max(abs($display['refresh']), $gpustat_cfg['UIREFRESHINT']);?>);
            }
        });
    });
</script>